<!-- Yes all of these are AI Generated, Sue Me -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-4 md:p-6" x-data="adminApp()" x-cloak>

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">Admin Panel</h1>
                <div class="flex space-x-2">
                    <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-medium">FastAPI</span>
                    <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-medium">Discord Bot</span>
                </div>
            </div>
            
            <!-- Messages -->
            <div x-show="globalError" class="mt-4 p-3 bg-red-500 bg-opacity-20 text-white border border-red-300 rounded-lg animate-fade-in" x-text="globalError"></div>
            <div x-show="globalSuccess" class="mt-4 p-3 bg-green-500 bg-opacity-20 text-white border border-green-300 rounded-lg animate-fade-in" x-text="globalSuccess" @click="globalSuccess = ''"></div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button 
                    @click="activeTab = 'characters'; resetMessages();" 
                    :class="activeTab === 'characters' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm flex items-center"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Characters
                </button>
                <button 
                    @click="activeTab = 'servers'; resetMessages(); loadServers();" 
                    :class="activeTab === 'servers' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm flex items-center"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    Servers & Channels
                </button>
                <button 
                    @click="activeTab = 'config'; resetMessages(); loadBotConfig();" 
                    :class="activeTab === 'config' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm flex items-center"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Bot Config
                </button>
            </nav>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Characters Tab -->
            <div x-show="activeTab === 'characters'" class="animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Characters Management
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Characters List -->
                    <div class="lg:col-span-1 bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Available Characters</h3>
                            <button @click="loadCharacters()" class="text-sm flex items-center text-indigo-600 hover:text-indigo-800">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        
                        <div class="space-y-2 max-h-[500px] overflow-y-auto scrollbar-thin">
                            <template x-for="charName in charactersList" :key="charName">
                                <div class="bg-white rounded-lg border border-gray-200 p-3 hover:shadow-md transition-shadow duration-200">
                                    <div class="flex justify-between items-center">
                                        <span x-text="charName" class="font-medium text-gray-800"></span>
                                        <div class="flex space-x-1">
                                            <button @click="getCharacter(charName)" class="p-1.5 rounded-md bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition-colors">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </button>
                                            <button @click="confirmDelete('character', charName)" class="p-1.5 rounded-md bg-red-100 text-red-700 hover:bg-red-200 transition-colors">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="charactersList.length === 0 && !loading" class="text-center py-4 text-gray-500">
                                No characters found
                            </div>
                            
                            <div x-show="loading" class="flex justify-center py-4">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                            </div>
                        </div>
                        
                        <button @click="resetCharacterForm(); editingCharacterName = ''" class="mt-4 w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create New Character
                        </button>
                        <button @click="importCharacter()" class="mt-4 w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Import Character
                        </button>
                    </div>
                    
                    <!-- Character Form -->
                    <div class="lg:col-span-2 bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-5">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">
                            <span x-text="editingCharacterName ? 'Edit Character: ' : 'Create New Character'"></span>
                            <span x-text="editingCharacterName" class="text-indigo-600"></span>
                        </h3>
                        
                        <form @submit.prevent="editingCharacterName ? updateCharacter() : createCharacter()" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" x-model="characterForm.name" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all" :disabled="editingCharacterName" required>
                                <p x-show="!editingCharacterName" class="text-xs text-gray-500 mt-1">This name will be used in the API path and cannot be changed after creation.</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Persona</label>
                                <textarea x-model="characterForm.persona" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all min-h-[100px]" required></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Examples (one per line)</label>
                                <textarea x-model="characterForm.examplesText" @input="characterForm.examples = characterForm.examplesText.split('\n').filter(Boolean)" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all min-h-[100px]"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Instructions</label>
                                <textarea x-model="characterForm.instructions" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all min-h-[100px]"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Avatar URL/Path</label>
                                    <input type="text" x-model="characterForm.avatar" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Info</label>
                                    <input type="text" x-model="characterForm.info" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                                </div>
                            </div>
                            
                            <div class="flex space-x-3 pt-2">
                                <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors duration-200 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                    </svg>
                                    <span x-text="editingCharacterName ? 'Save Changes' : 'Create Character'"></span>
                                </button>
                                <button type="button" @click="resetCharacterForm()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors duration-200">
                                    Cancel
                                </button>
                            </div>
                        </form>
                        
                        <!-- Advanced Patch Section -->
                        <div x-show="editingCharacterName" class="mt-8 pt-6 border-t border-gray-200">
                            <h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Advanced: Patch Character
                            </h4>
                            
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                                    <div class="md:col-span-4">
                                        <input type="text" x-model="patchOp.path" placeholder="JSON Path (e.g., /persona)" class="w-full px-3 py-2 rounded border border-gray-300 text-sm">
                                    </div>
                                    <div class="md:col-span-3">
                                        <select x-model="patchOp.op" class="w-full px-3 py-2 rounded border border-gray-300 text-sm bg-white">
                                            <option value="replace">Replace</option>
                                            <option value="add">Add</option>
                                            <option value="remove">Remove</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4" x-show="patchOp.op !== 'remove'">
                                        <input type="text" x-model="patchOp.value" placeholder="Value (JSON string or number)" class="w-full px-3 py-2 rounded border border-gray-300 text-sm">
                                    </div>
                                    <div class="md:col-span-1">
                                        <button @click="addPatchOperation()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm flex items-center justify-center">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <div x-show="patchOperations.length > 0" class="mt-4">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">Operations to send:</h5>
                                    <div class="bg-white rounded border border-gray-200 p-3 max-h-40 overflow-y-auto scrollbar-thin">
                                        <ul class="space-y-2">
                                            <template x-for="(op, index) in patchOperations" :key="index">
                                                <li class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
                                                    <span class="font-mono">
                                                        <span x-text="op.op" class="font-semibold"></span>: 
                                                        <span x-text="op.path"></span>
                                                        <span x-show="op.op !== 'remove'"> = <span x-text="op.value" class="text-indigo-600"></span></span>
                                                    </span>
                                                    <button @click="patchOperations.splice(index, 1)" class="text-red-500 hover:text-red-700">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </button>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                    <button @click="executePatch('character', editingCharacterName)" class="mt-3 w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm flex items-center justify-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Execute Patch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Servers Tab -->
            <div x-show="activeTab === 'servers'" class="animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    Servers & Channels Management
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Servers List -->
                    <div class="lg:col-span-1 bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Servers</h3>
                            <button @click="loadServers()" class="text-sm flex items-center text-indigo-600 hover:text-indigo-800">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        
                        <div class="space-y-3 max-h-[500px] overflow-y-auto scrollbar-thin">
                            <template x-for="serverName in serversList" :key="serverName">
                                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                                    <div 
                                        @click="selectServer(serverName)" 
                                        class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors"
                                    >
                                        <div class="flex items-center">
                                            <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                                            </svg>
                                            <span x-text="serverName" class="font-medium text-gray-800"></span>
                                        </div>
                                        <span x-text="selectedServer === serverName ? '▼' : '▶'" class="text-gray-500"></span>
                                    </div>
                                    
                                    <div x-show="selectedServer === serverName" class="border-t border-gray-200 bg-gray-50 p-3 space-y-2">
                                        <h4 class="text-sm font-medium text-gray-700 flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                            </svg>
                                            Channels
                                        </h4>
                                        
                                        <ul class="space-y-2">
                                            <template x-for="channelName in channelsList" :key="channelName">
                                                <li class="flex justify-between items-center bg-white rounded border border-gray-200 p-2 text-sm">
                                                    <span x-text="channelName" class="truncate"></span>
                                                    <div class="flex space-x-1">
                                                        <button @click="getChannel(serverName, channelName)" class="p-1 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200">
                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                            </svg>
                                                        </button>
                                                        <button @click="confirmDelete('channel', {serverName, channelName})" class="p-1 rounded bg-red-100 text-red-700 hover:bg-red-200">
                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                        
                                        <div x-show="channelsList.length === 0 && !loadingChannels" class="text-center py-2 text-gray-500 text-sm">
                                            No channels found
                                        </div>
                                        
                                        <div x-show="loadingChannels" class="flex justify-center py-2">
                                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-600"></div>
                                        </div>
                                        
                                        <button @click="prepareNewChannel(serverName)" class="w-full mt-2 py-1.5 px-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs flex items-center justify-center">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            New Channel
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <button @click="prepareNewChannel('', true)" class="mt-4 w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create New Server
                        </button>
                    </div>
                    
                    <!-- Channel Form -->
                    <div class="lg:col-span-2 bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-5" x-show="currentChannelForm.serverName || creatingNewChannel">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">
                            <span x-text="editingChannelName ? 'Edit Channel: ' : (creatingNewChannel ? 'Create New ' + (creatingNewChannelWithNewServer ? 'Server' : 'Channel') : '')"></span>
                            <span x-text="editingChannelName || ''" class="text-indigo-600"></span>
                            <span x-show="editingChannelName" class="text-gray-600">(Server: <span x-text="currentChannelForm.serverName" class="font-medium"></span>)</span>
                        </h3>
                        
                        <form @submit.prevent="editingChannelName ? updateChannel() : createChannel()" class="space-y-4">
                            <div x-show="creatingNewChannel">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Server Name</label>
                                <input type="text" x-model="currentChannelForm.serverName" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all" :disabled="!creatingNewChannelWithNewServer" required>
                                <div class="mt-1 flex items-center">
                                    <input type="checkbox" id="newServerCheckbox" x-model="creatingNewChannelWithNewServer" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <label for="newServerCheckbox" class="ml-2 text-sm text-gray-600">Create in a new server</label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Channel Name</label>
                                <input type="text" x-model="currentChannelForm.name" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all" :disabled="editingChannelName" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Instruction</label>
                                <textarea x-model="currentChannelForm.instruction" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all min-h-[100px]"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Global Variables (key=value pairs, one per line)</label>
                                <textarea x-model="currentChannelForm.globalvar" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all min-h-[80px]"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                <input type="text" x-model="currentChannelForm.location" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                            </div>
                            
                            <!-- Lorebook -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lorebook Entries</label>
                                <div class="space-y-2 mb-3 max-h-40 overflow-y-auto scrollbar-thin">
                                    <template x-for="(value, key) in currentChannelForm.lorebook" :key="key">
                                        <div class="flex items-center space-x-2">
                                            <input type="text" :value="key" class="flex-1 px-3 py-1 rounded border border-gray-300 text-sm" disabled>
                                            <input type="text" x-model="currentChannelForm.lorebook[key]" class="flex-1 px-3 py-1 rounded border border-gray-300 text-sm">
                                            <button type="button" @click="removeLorebookEntry(key)" class="p-1 rounded-full bg-red-100 text-red-600 hover:bg-red-200">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="text" x-model="newLorebookEntry.key" placeholder="Key" class="flex-1 px-3 py-1 rounded border border-gray-300 text-sm">
                                    <input type="text" x-model="newLorebookEntry.value" placeholder="Value" class="flex-1 px-3 py-1 rounded border border-gray-300 text-sm">
                                    <button type="button" @click="addLorebookEntry()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">
                                        Add
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Whitelist -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Whitelist</label>
                                <div class="space-y-2 mb-3 max-h-40 overflow-y-auto scrollbar-thin">
                                    <template x-for="(item, index) in currentChannelForm.whitelist" :key="index">
                                        <div class="flex items-center space-x-2">
                                            <input type="text" x-model="currentChannelForm.whitelist[index]" class="flex-1 px-3 py-1 rounded border border-gray-300 text-sm">
                                            <button type="button" @click="currentChannelForm.whitelist.splice(index, 1)" class="p-1 rounded-full bg-red-100 text-red-600 hover:bg-red-200">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="text" x-model="newWhitelistItem" placeholder="Add to whitelist" class="flex-1 px-3 py-1 rounded border border-gray-300 text-sm">
                                    <button type="button" @click="addWhitelistItem()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">
                                        Add
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3 pt-2">
                                <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors duration-200 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                    </svg>
                                    <span x-text="editingChannelName ? 'Save Changes' : 'Create ' + (creatingNewChannelWithNewServer ? 'Server' : 'Channel')"></span>
                                </button>
                                <button type="button" @click="resetChannelForm()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition-colors duration-200">
                                    Cancel
                                </button>
                            </div>
                        </form>
                        
                        <!-- Advanced Patch Section -->
                        <div x-show="editingChannelName" class="mt-8 pt-6 border-t border-gray-200">
                            <h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Advanced: Patch Channel
                            </h4>
                            
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                                    <div class="md:col-span-4">
                                        <input type="text" x-model="patchOp.path" placeholder="JSON Path (e.g., /instruction)" class="w-full px-3 py-2 rounded border border-gray-300 text-sm">
                                    </div>
                                    <div class="md:col-span-3">
                                        <select x-model="patchOp.op" class="w-full px-3 py-2 rounded border border-gray-300 text-sm bg-white">
                                            <option value="replace">Replace</option>
                                            <option value="add">Add</option>
                                            <option value="remove">Remove</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4" x-show="patchOp.op !== 'remove'">
                                        <input type="text" x-model="patchOp.value" placeholder="Value (JSON string or number)" class="w-full px-3 py-2 rounded border border-gray-300 text-sm">
                                    </div>
                                    <div class="md:col-span-1">
                                        <button @click="addPatchOperation()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm flex items-center justify-center">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <div x-show="patchOperations.length > 0" class="mt-4">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">Operations to send:</h5>
                                    <div class="bg-white rounded border border-gray-200 p-3 max-h-40 overflow-y-auto scrollbar-thin">
                                        <ul class="space-y-2">
                                            <template x-for="(op, index) in patchOperations" :key="index">
                                                <li class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
                                                    <span class="font-mono">
                                                        <span x-text="op.op" class="font-semibold"></span>: 
                                                        <span x-text="op.path"></span>
                                                        <span x-show="op.op !== 'remove'"> = <span x-text="op.value" class="text-indigo-600"></span></span>
                                                    </span>
                                                    <button @click="patchOperations.splice(index, 1)" class="text-red-500 hover:text-red-700">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </button>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                    <button @click="executePatch('channel', {serverName: currentChannelForm.serverName, channelName: editingChannelName})" class="mt-3 w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm flex items-center justify-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Execute Patch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div x-show="activeTab === 'config'" class="animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Bot Configuration
                </h2>
                
                <div class="max-w-3xl mx-auto bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-6">
                    <form @submit.prevent="updateBotConfig()" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default Character</label>
                                <input type="text" x-model="botConfigForm.default_character" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">AI API Endpoint</label>
                                <input type="text" x-model="botConfigForm.ai_endpoint" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Base LLM Model</label>
                                <input type="text" x-model="botConfigForm.base_llm" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Temperature</label>
                                <input type="number" step="0.01" x-model.number="botConfigForm.temperature" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">AI API Key</label>
                                <input type="password" x-model="botConfigForm.ai_key" placeholder="Enter new key or leave blank to keep existing" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Discord API Key</label>
                                <input type="password" x-model="botConfigForm.discord_key" placeholder="Enter new key or leave blank to keep existing" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition-all">
                            </div>
                        </div>
                        
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors duration-200 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                                Save Configuration
                            </button>
                        </div>
                    </form>
                    
                    <!-- Advanced Patch Section -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Advanced: Patch Configuration
                        </h4>
                        
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                                <div class="md:col-span-4">
                                    <input type="text" x-model="patchOp.path" placeholder="JSON Path (e.g., /temperature)" class="w-full px-3 py-2 rounded border border-gray-300 text-sm">
                                </div>
                                <div class="md:col-span-3">
                                    <select x-model="patchOp.op" class="w-full px-3 py-2 rounded border border-gray-300 text-sm bg-white">
                                        <option value="replace">Replace</option>
                                        <option value="add">Add</option>
                                        <option value="remove">Remove</option>
                                    </select>
                                </div>
                                <div class="md:col-span-4" x-show="patchOp.op !== 'remove'">
                                    <input type="text" x-model="patchOp.value" placeholder="Value (JSON string or number)" class="w-full px-3 py-2 rounded border border-gray-300 text-sm">
                                </div>
                                <div class="md:col-span-1">
                                    <button @click="addPatchOperation()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm flex items-center justify-center">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div x-show="patchOperations.length > 0" class="mt-4">
                                <h5 class="text-sm font-medium text-gray-700 mb-2">Operations to send:</h5>
                                <div class="bg-white rounded border border-gray-200 p-3 max-h-40 overflow-y-auto scrollbar-thin">
                                    <ul class="space-y-2">
                                        <template x-for="(op, index) in patchOperations" :key="index">
                                            <li class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
                                                <span class="font-mono">
                                                    <span x-text="op.op" class="font-semibold"></span>: 
                                                    <span x-text="op.path"></span>
                                                    <span x-show="op.op !== 'remove'"> = <span x-text="op.value" class="text-indigo-600"></span></span>
                                                </span>
                                                <button @click="patchOperations.splice(index, 1)" class="text-red-500 hover:text-red-700">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                                <button @click="executePatch('config', null)" class="mt-3 w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Execute Patch
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Discord Bot Controller -->
            <div class="mt-8 pt-6 border-t border-gray-200" x-init="checkDiscordBotStatus()">
                <h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Discord Bot Control
                </h4>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex flex-col md:flex-row items-center justify-between">
                        <div class="flex items-center mb-4 md:mb-0">
                            <div class="mr-3">
                                <span x-show="botStatus === 'active'" class="flex h-3 w-3">
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                    </span>
                                </span>
                                <span x-show="botStatus === 'inactive'" class="flex h-3 w-3">
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-gray-400"></span>
                                </span>
                                <span x-show="botStatus === 'error'" class="flex h-3 w-3">
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">
                                    Status: 
                                    <span x-text="botStatus === 'active' ? 'Online' : botStatus === 'inactive' ? 'Offline' : 'Error'" 
                                          :class="botStatus === 'active' ? 'text-green-600' : botStatus === 'inactive' ? 'text-gray-600' : 'text-red-600'">
                                    </span>
                                </p>
                                <p x-show="lastActivated" class="text-xs text-gray-500">Last activated: <span x-text="lastActivated"></span></p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button @click="activateDiscordBot()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors duration-200 flex items-center shadow-sm" :disabled="botStatus === 'active'">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 127.14 96.36" fill="currentColor">
                                    <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
                                </svg>
                                Activate Discord Bot
                            </button>
                            
                            <button @click="stopDiscordBot()" x-show="botStatus === 'active'" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors duration-200 flex items-center shadow-sm">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                                </svg>
                                Stop Bot
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
    function adminApp() {
        return {
            apiUrl: '', // CHANGE THIS IF YOUR API IS ELSEWHERE
            activeTab: 'characters',
            loading: false,
            loadingChannels: false,
            globalError: '',
            globalSuccess: '',

            // Character Data
            charactersList: [],
            editingCharacterName: null, // stores name of char being edited
            characterForm: {
                name: '',
                persona: '',
                examples: [],
                examplesText: '', // for textarea binding
                instructions: '',
                avatar: '',
                info: ''
            },
            defaultCharacterForm: { name: '', persona: '', examples: [], examplesText: '', instructions: '', avatar: '', info: ''},

            // Server & Channel Data
            serversList: [],
            selectedServer: null,
            channelsList: [],
            editingChannelName: null, // stores name of channel being edited
            creatingNewChannel: false,
            creatingNewChannelWithNewServer: false,
            currentChannelForm: { // for both create and edit
                serverName: '', // used to know which server context
                name: '',
                instruction: '',
                globalvar: '',
                location: '',
                lorebook: {},
                whitelist: []
            },
            defaultChannelForm: { serverName: '', name: '', instruction: '', globalvar: '', location: '', lorebook: {}, whitelist: [] },
            newLorebookEntry: { key: '', value: '' },
            newWhitelistItem: '',

            // Bot Config Data
            botConfigForm: {
                default_character: '',
                ai_endpoint: '',
                base_llm: '',
                temperature: 0.5,
                ai_key: '',
                discord_key: ''
            },
            defaultBotConfigForm: { default_character: '', ai_endpoint: '', base_llm: '', temperature: 0.5, ai_key: '', discord_key: '' },
            
            // Patch Data
            patchOp: { op: 'replace', path: '', value: '' },
            patchOperations: [],

            init() {
                this.loadCharacters(); // Load initial data for the first tab
                this.defaultCharacterForm = JSON.parse(JSON.stringify(this.characterForm));
                this.defaultChannelForm = JSON.parse(JSON.stringify(this.currentChannelForm));
                this.defaultBotConfigForm = JSON.parse(JSON.stringify(this.botConfigForm));
            },

            resetMessages() {
                this.globalError = '';
                this.globalSuccess = '';
            },
            botStatus: 'inactive', // 'active', 'inactive', 'error'
            lastActivated: null,
            
            activateDiscordBot() {
                // Show loading state
                this.botStatus = 'loading';
                
                // API call to activate bot
                fetch('/discord/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.botStatus = 'active';
                        this.lastActivated = new Date().toLocaleString();
                        
                        // Show notification
                        //this.showNotification('Discord bot activated successfully!', 'success');
                    } else {
                        this.botStatus = 'error';
                        //this.showNotification('Failed to activate Discord bot: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    this.botStatus = 'error';
                    //this.showNotification('Error activating Discord bot: ' + error.message, 'error');
                });
            },
            
            stopDiscordBot() {
                // API call to stop bot
                fetch('/discord/deactivate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.botStatus = 'inactive';
                        //this.showNotification('Discord bot stopped successfully!', 'success');
                    } else {
                        //this.showNotification('Failed to stop Discord bot: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    // this.showNotification('Error stopping Discord bot: ' + error.message, 'error');
                });
            },

            checkDiscordBotStatus() {
                fetch('/discord/status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    this.botStatus = data.status;
                })
                .catch(error => {
                    this.botStatus = 'error';
                });
            },

            async fetchAPI(endpoint, options = {}) {
                this.loading = true;
                this.resetMessages();
                try {
                    const response = await fetch(`${this.apiUrl}${endpoint}`, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }
                    if (response.status === 204 || response.headers.get("content-length") === "0") { // Handle No Content
                        return null; 
                    }
                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error);
                    this.globalError = `Error: ${error.message}`;
                    throw error; // re-throw to stop further processing in calling function
                } finally {
                    this.loading = false;
                }
            },

            // Character Methods
            async loadCharacters() {
                try {
                    this.charactersList = await this.fetchAPI('/characters');
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async getCharacter(name) {
                try {
                    const data = await this.fetchAPI(`/characters/${name}`);
                    this.characterForm = { ...data, examplesText: data.examples.join('\n') };
                    this.editingCharacterName = name;
                    this.patchOperations = []; // Clear patch ops when loading new item
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async createCharacter() {
                if (!this.characterForm.name) {
                    this.globalError = "Character name is required.";
                    return;
                }
                // Ensure examples is an array of strings
                this.characterForm.examples = this.characterForm.examplesText.split('\n').filter(Boolean);
                const payload = { ...this.characterForm };
                delete payload.examplesText;

                try {
                    await this.fetchAPI(`/characters/${this.characterForm.name}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    this.globalSuccess = `Character '${this.characterForm.name}' created successfully.`;
                    this.resetCharacterForm();
                    this.loadCharacters();
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async updateCharacter() {
                 // Ensure examples is an array of strings
                this.characterForm.examples = this.characterForm.examplesText.split('\n').filter(Boolean);
                const payload = { ...this.characterForm };
                delete payload.examplesText;

                try {
                    await this.fetchAPI(`/characters/${this.editingCharacterName}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    this.globalSuccess = `Character '${this.editingCharacterName}' updated successfully.`;
                    this.loadCharacters(); // Refresh list in case name was part of it (though not editable here)
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async deleteCharacter(name) {
                try {
                    await this.fetchAPI(`/characters/${name}`, { method: 'DELETE' });
                    this.globalSuccess = `Character '${name}' deleted successfully.`;
                    this.loadCharacters();
                    if (this.editingCharacterName === name) {
                        this.resetCharacterForm();
                    }
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async importCharacter() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json,application/json';
                
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        // Read the file contents as text
                        const fileText = await file.text();
                        console.log("File content read as text:", fileText.substring(0, 100) + "..."); // Log first 100 chars
                        
                        try {
                            // Try parsing to validate it's JSON, but we'll send as text
                            JSON.parse(fileText);
                            console.log("Successfully validated as JSON");
                        } catch (parseError) {
                            console.error("File is not valid JSON:", parseError);
                            this.globalError = "Selected file is not valid JSON";
                            return;
                        }
                        
                        // Send as raw text with Content-Type: text/plain to avoid frontend processing
                        console.log("Sending to API...");
                        const response = await fetch('/characters/import_character', {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: fileText  // Send the raw text content
                        });
                        
                        if (!response.ok) {
                            let errorDetailString = response.statusText; // Default
                            try {
                                const errorResponse = await response.json();
                                console.error("Full server 422 error object:", errorResponse); // Log the whole object
                                if (errorResponse.detail) {
                                    if (typeof errorResponse.detail === 'string') {
                                        errorDetailString = errorResponse.detail;
                                    } else {
                                        // If detail is an object or array, stringify it for display
                                        errorDetailString = JSON.stringify(errorResponse.detail, null, 2);
                                    }
                                }
                            } catch (e) {
                                // If parsing the error response as JSON fails, stick to statusText
                                console.error("Could not parse error response as JSON:", e);
                            }
                            this.globalError = `Failed to import character: Server error (${response.status}): ${errorDetailString.detail}`;
                            console.error('Import error:', this.globalError); // Log the constructed error message
                            return; // Stop further execution in this function
                        }
                        const importedCharacter = await response.json();
                        
                        this.globalSuccess = `Character '${importedCharacter.name}' imported successfully!`;
                        this.loadCharacters();
                        
                        if (this.showCharacterEditor) {
                            this.getCharacter(importedCharacter.name);
                        }
                    } catch (error) {
                        this.globalError = `Failed to import character: ${error.message}`;
                        console.error('Import error:', error);
                    }
                };
                
                fileInput.click();
            },
            resetCharacterForm() {
                this.characterForm = JSON.parse(JSON.stringify(this.defaultCharacterForm));
                this.editingCharacterName = null;
                this.patchOperations = [];
            },

            // Server & Channel Methods
            async loadServers() {
                try {
                    this.serversList = await this.fetchAPI('/servers');
                    if (this.serversList.length > 0 && !this.selectedServer) {
                        // Optionally auto-select first server or handle as needed
                    } else if (this.serversList.length === 0) {
                        this.selectedServer = null;
                        this.channelsList = [];
                    }
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async selectServer(serverName) {
                this.selectedServer = serverName;
                this.channelsList = []; // Clear previous channels
                this.resetChannelForm(); // Clear any edit/create form for channels
                this.creatingNewChannel = false;
                await this.loadChannels(serverName);
            },
            async loadChannels(serverName) {
                if (!serverName) return;
                this.loadingChannels = true;
                try {
                    this.channelsList = await this.fetchAPI(`/servers/${serverName}/channels`);
                } catch (e) { /* error handled by fetchAPI */ }
                finally { this.loadingChannels = false; }
            },
            prepareNewChannel(serverName) {
                this.resetChannelForm();
                this.currentChannelForm.serverName = serverName;
                this.editingChannelName = null;
                this.creatingNewChannel = true;
                this.creatingNewChannelWithNewServer = false; // Default to existing server
            },
            async getChannel(serverName, channelName) {
                try {
                    const data = await this.fetchAPI(`/servers/${serverName}/channels/${channelName}`);
                    this.currentChannelForm = { ...data, serverName: serverName }; // Add serverName for context
                    this.editingChannelName = channelName;
                    this.creatingNewChannel = false;
                    this.patchOperations = [];
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async createChannel() {
                if (!this.currentChannelForm.serverName || !this.currentChannelForm.name) {
                    this.globalError = "Server name and Channel name are required.";
                    return;
                }
                const payload = { ...this.currentChannelForm };
                // serverName is for path, not body of ChannelModel
                const serverForPath = payload.serverName; 
                delete payload.serverName; 

                try {
                    await this.fetchAPI(`/servers/${serverForPath}/channels/${payload.name}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    this.globalSuccess = `Channel '${payload.name}' created in server '${serverForPath}'.`;
                    this.resetChannelForm();
                    if (this.selectedServer === serverForPath) {
                        this.loadChannels(serverForPath);
                    }
                    if (!this.serversList.includes(serverForPath)) { // If it was a new server
                        this.loadServers();
                    }
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async updateChannel() {
                const payload = { ...this.currentChannelForm };
                const serverForPath = payload.serverName;
                delete payload.serverName;

                try {
                    await this.fetchAPI(`/servers/${serverForPath}/channels/${this.editingChannelName}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    this.globalSuccess = `Channel '${this.editingChannelName}' updated.`;
                    if (this.selectedServer === serverForPath) {
                        this.loadChannels(serverForPath);
                    }
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async deleteChannel(params) { // params = {serverName, channelName}
                try {
                    await this.fetchAPI(`/servers/${params.serverName}/channels/${params.channelName}`, { method: 'DELETE' });
                    this.globalSuccess = `Channel '${params.channelName}' in server '${params.serverName}' deleted.`;
                    if (this.selectedServer === params.serverName) {
                        this.loadChannels(params.serverName);
                    }
                    if (this.editingChannelName === params.channelName && this.currentChannelForm.serverName === params.serverName) {
                        this.resetChannelForm();
                    }
                } catch (e) { /* error handled by fetchAPI */ }
            },
            resetChannelForm() {
                this.currentChannelForm = JSON.parse(JSON.stringify(this.defaultChannelForm));
                this.editingChannelName = null;
                this.creatingNewChannel = false;
                this.creatingNewChannelWithNewServer = false;
                this.newLorebookEntry = { key: '', value: '' };
                this.newWhitelistItem = '';
                this.patchOperations = [];
            },
            addLorebookEntry() {
                if (this.newLorebookEntry.key && this.newLorebookEntry.value) {
                    this.currentChannelForm.lorebook[this.newLorebookEntry.key] = this.newLorebookEntry.value;
                    this.newLorebookEntry = { key: '', value: '' };
                }
            },
            removeLorebookEntry(key) {
                delete this.currentChannelForm.lorebook[key];
            },
            addWhitelistItem() {
                if (this.newWhitelistItem && !this.currentChannelForm.whitelist.includes(this.newWhitelistItem)) {
                    this.currentChannelForm.whitelist.push(this.newWhitelistItem);
                    this.newWhitelistItem = '';
                }
            },

            // Bot Config Methods
            async loadBotConfig() {
                try {
                    const data = await this.fetchAPI('/config');
                    this.botConfigForm = { ...this.defaultBotConfigForm, ...data }; // Merge with defaults to ensure all fields
                    // Clear password fields for security, they are write-only
                    this.botConfigForm.ai_key = ''; 
                    this.botConfigForm.discord_key = '';
                    this.patchOperations = [];
                } catch (e) { /* error handled by fetchAPI */ }
            },
            async updateBotConfig() {
                const payload = { ...this.botConfigForm };
                // Only include keys if they have a value, to avoid sending empty strings and overwriting existing valid keys
                if (!payload.ai_key) delete payload.ai_key;
                if (!payload.discord_key) delete payload.discord_key;

                try {
                    await this.fetchAPI('/config', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    this.globalSuccess = 'Bot configuration updated successfully.';
                    this.loadBotConfig(); // Reload to reflect changes and clear keys
                } catch (e) { /* error handled by fetchAPI */ }
            },

            // PATCH Methods
            addPatchOperation() {
                if (!this.patchOp.path) {
                    this.globalError = "Patch path is required.";
                    return;
                }
                // For 'add' and 'replace', value can be a string, number, boolean, or even JSON string for object/array
                let valueToStore = this.patchOp.value;
                try {
                    // Attempt to parse if it looks like JSON (object, array, true, false, null, number)
                    if (['{', '[', 'true', 'false', 'null'].some(char => this.patchOp.value.trim().startsWith(char)) || !isNaN(parseFloat(this.patchOp.value))) {
                         valueToStore = JSON.parse(this.patchOp.value);
                    }
                } catch (e) {
                    // If parsing fails, keep it as a string. This is fine for simple string values.
                }

                this.patchOperations.push({ 
                    op: this.patchOp.op, 
                    path: this.patchOp.path, 
                    value: this.patchOp.op === 'remove' ? undefined : valueToStore
                });
                this.patchOp = { op: 'replace', path: '', value: '' }; // Reset for next op
                this.resetMessages();
            },
            async executePatch(type, identifier) { // type: 'character', 'channel', 'config'. identifier: name or {server,channel}
                if (this.patchOperations.length === 0) {
                    this.globalError = "No patch operations to send.";
                    return;
                }
                let endpoint = '';
                if (type === 'character') endpoint = `/characters/${identifier}`;
                else if (type === 'channel') endpoint = `/servers/${identifier.serverName}/channels/${identifier.channelName}`;
                else if (type === 'config') endpoint = `/config`;
                else {
                    this.globalError = "Invalid patch type.";
                    return;
                }

                try {
                    await this.fetchAPI(endpoint, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.patchOperations)
                    });
                    this.globalSuccess = `${type} patched successfully. Reloading data...`;
                    this.patchOperations = [];
                    // Reload relevant data
                    if (type === 'character') this.getCharacter(identifier);
                    else if (type === 'channel') this.getChannel(identifier.serverName, identifier.channelName);
                    else if (type === 'config') this.loadBotConfig();
                } catch (e) { /* error handled by fetchAPI */ }
            },

            confirmDelete(type, identifier) {
                let itemName = '';
                if (type === 'character') itemName = identifier;
                else if (type === 'channel') itemName = `${identifier.channelName} in server ${identifier.serverName}`;
                
                if (confirm(`Are you sure you want to delete ${type} '${itemName}'? This cannot be undone.`)) {
                    if (type === 'character') this.deleteCharacter(identifier);
                    else if (type === 'channel') this.deleteChannel(identifier);
                }
            }
        }
    }
    </script>
</body>
</html>